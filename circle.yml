machine:
  environment:
    PATH: ${HOME}/extras/bin:${HOME}/extras/otp/19.0/bin:${PATH}
dependencies:
  cache_directories:
    - ~/extras
    - ~/.dialyzer_core*
    - ~/.rebar
    - .rebar
    - .cache
    - ~/.cache
  pre:
    - sudo apt-get update
    - sudo apt-get install -y libzookeeper-mt-dev libzookeeper-mt2 zookeeper zookeeper-bin zookeeperd splint-data splint software-properties-common clang libssl-dev
    - sudo add-apt-repository -y ppa:george-edison55/cmake-3.x
    - sudo apt-get update
    - sudo apt-get install cmake
    - echo 'JAVA_OPTS="-Xms512m -Xmx2048m"' | sudo tee /etc/default/zookeeper
    - curl -O -L https://raw.githubusercontent.com/yrashk/kerl/master/kerl && chmod 755 kerl
    - if [ ! -d ~/extras/otp/19.0 ]; then ./kerl build 19.0 19.0; ./kerl install 19.0 ~/extras/otp/19.0; fi:
        timeout: 1800
  override:
    - make

test:
  override:
    - make check
    - sudo bash -c 'source ~/extras/otp/19.0/activate && make check'
  post:
    - git clone https://github.com/idubrov/covertool
    - cd covertool && ../rebar3 compile
    - cd covertool && ../rebar3 escriptize
    - sudo pip install codecov
    - covertool/_build/default/bin/covertool -cover _build/test/cover/eunit.coverdata -appname urilib -output eunit.cobertura.xml; codecov -X gcov -f eunit.cobertura.xml;
    - covertool/_build/default/bin/covertool -cover _build/test/cover/ct.coverdata -appname urilib -output ct.cobertura.xml; codecov -X gcov -f ct.cobertura.xml;
    - mkdir -p $CIRCLE_TEST_REPORTS/
    - mv TEST-*.xml $CIRCLE_TEST_REPORTS
    - cp -r _build/test/cover $CIRCLE_TEST_REPORTS
